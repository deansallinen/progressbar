<script lang="ts">
  import { db, type ActiveExercise } from "$lib/db";
  import { updateActiveWorkoutSets } from "$lib/state/workout.svelte";

  interface Props {
    exercise: ActiveExercise;
  }

  const { exercise }: Props = $props();

  const setWorkingWeight = async (
    exerciseId: number,
    workingWeight: number,
  ) => {
    await db.exercises.update(exerciseId, { workingWeight });
    await updateActiveWorkoutSets(exerciseId, workingWeight);
  };

  const getWorkingWeight = async (exerciseId: number) => {
    const exercise = await db.exercises.get(exerciseId);
    if (!exercise) return null;
    return exercise.workingWeight;
  };

  const workingWeight = await getWorkingWeight(exercise.exerciseId);

  let editing = $state(false);
</script>

{#if editing}
  <div class="flex items-center justify-start gap-2">
    <input
      class=""
      id="{exercise.exerciseId}-weight"
      type="number"
      disabled={!editing}
      value={workingWeight}
      oninput={(e) => {
        setWorkingWeight(exercise.exerciseId, e.currentTarget.valueAsNumber);
      }}
      min="0"
      step="5"
    />
    <button
      aria-label="Finish editing working weight"
      type="button"
      onclick={() => (editing = !editing)}
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="lucide lucide-check-icon lucide-check"
        ><path d="M20 6 9 17l-5-5" /></svg
      >
    </button>
  </div>
{:else}
  <div class="flex grow justify-between items-center">
    <span class="text-lg mb-2">
      @{workingWeight}
    </span>
    <button
      onclick={() => (editing = !editing)}
      type="button"
      class="outline secondary"
      aria-label="Edit working weight"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="lucide lucide-pencil-icon lucide-pencil"
        ><path
          d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"
        /><path d="m15 5 4 4" /></svg
      >
    </button>
  </div>
{/if}
